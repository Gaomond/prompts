# System E2E Testing Guidelines
E2Eテストの作成及びF/Eの実装タスクではこのファイルを参照してください。

システム全体の振る舞いを保証するためのE2Eテストに関するガイドラインです。

## 1. Purpose & Scope
* **Goal:** フロントエンド、バックエンド、データベース、インフラが全て接続された状態での「疎通」と「主要なユーザーシナリオ」を保証する。
* **Philosophy:** **"No Mocks"**. 可能な限り本物の環境（Dockerコンテナ）を使用し、システムとしての「嘘」を暴く最後の砦とする。

## 2. Tech Stack
* **Framework:** Playwright (Node.js/TypeScript)
* **BDD Layer:** `playwright-bdd` (Gherkin to Playwright generator)
* **Target Browsers:** Chromium, Mobile Chrome (Responsive)

## 3. Directory Structure
apps/直下で管理します。

```text
apps/tests/e2e/
├── features/             # [Spec] Gherkin (*.feature)
├── steps/                # [Impl] Step Definitions (*.ts)
├── .features-gen/        # [Gen] Auto-generated Playwright tests
├── package.json
└── playwright.config.ts
```

## 4\. Implementation Workflow (AI-Native)

Gherkinを仕様の「正」とし、実装はAIに委譲するフローを基本とします。

1.  **Define:** 人間が `features/*.feature` (Gherkin) を記述する。
2.  **Generate:** AIにGherkinを渡し、対応する `steps/*.ts` を生成させる。
3.  **Compile:** `npx bddgen` でPlaywrightテストコードへ変換する。
4.  **Run:** `npx playwright test` で実行する。

## 5\. Data Management Strategy

E2Eテストの安定性を担保するため、データのセットアップにはUI操作ではなく、**DB直接操作**または**APIコール**を使用します。

  * **Given句 (Setup):** `mongodb` ドライバ等を使用し、テスト開始前にDBへ直接データを投入する（UI操作によるセットアップは不安定なため避ける）。
  * **When句 (Action):** ブラウザ (Playwright `page`) を操作する。
  * **Then句 (Assert):** ブラウザ上の表示 (`expect(page...)`) を検証する。


## 6\. Test ID Policy (Strict)

**CSSセレクタやテキスト依存のテストは禁止します。**
フロントエンド実装者は、E2Eテストの安定化のため、操作・検証対象となる主要な要素に必ず `data-testid` 属性を付与する義務を負います。

### Naming Convention

**Format:** `[context]-[action/role]-[element]` (kebab-case)

| Element Type | Pattern | Example (Health Check) |
| :--- | :--- | :--- |
| **Input Field** | `...-input` | `health-echo-input` |
| **Button/Link** | `...-button` | `health-fetch-button`<br>`health-save-button` |
| **Display Area** | `...-display` | `health-status-display`<br>`health-message-display` |
| **Container** | `...-container` | `health-monitor-container` |
| **List Item** | `...-item` | `health-log-item` |

### Implementation Example (Frontend)

```tsx
// Good: デザイン変更に強い
<button data-testid="health-fetch-button" onClick={handleFetch}>
  Reload
</button>

// Bad: デザイン変更で壊れる可能性がある
<button className="btn-primary" onClick={handleFetch}>
  Reload
</button>
```

### Automation Example (Step Definition)

AIには以下の形式でセレクタを指定させること。

```ts
// Good
await page.getByTestId('health-fetch-button').click();

// Bad
await page.click('button.btn-primary');
await page.getByText('Reload').click();
```

```


